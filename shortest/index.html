<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>最短フォーム | MensEstheSuite</title>
  <meta name="color-scheme" content="light dark">
  <style>
    :root{--bg:#0b0c0f;--card:#151922;--text:#e7eaf0;--muted:#9aa4b2;--accent:#4da3ff;--ok:#22c55e;--warn:#f59e0b;}
    html,body{height:100%;margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,'Noto Sans JP','Hiragino Kaku Gothic ProN',Meiryo,sans-serif;background:var(--bg);color:var(--text);}
    .wrap{max-width:640px;margin:0 auto;padding:24px;}
    .card{background:var(--card);border:1px solid rgba(255,255,255,.08);border-radius:16px;padding:20px;box-shadow:0 6px 24px rgba(0,0,0,.25);}
    .row{display:flex;gap:12px;align-items:center;flex-wrap:wrap;margin-top:12px}
    .title{font-size:20px;font-weight:700;margin:0 0 6px}
    .muted{color:var(--muted);font-size:13px}
    .btn{appearance:none;border:1px solid rgba(255,255,255,.12);background:#1f2937;color:#fff;padding:10px 14px;border-radius:12px;cursor:pointer}
    .btn:hover{filter:brightness(1.08)}
    .btn:disabled{opacity:.5;cursor:not-allowed}
    .btn.primary{background:var(--accent);border-color:#2a7bd6}
    .btn.ok{background:var(--ok);border-color:#16a34a}
    .field{flex:1;min-width:160px}
    .input{width:100%;padding:12px 14px;border-radius:12px;border:1px solid rgba(255,255,255,.12);background:#0f1218;color:#fff;font-size:18px;letter-spacing:.2em;text-align:center}
    .help{font-size:12px;color:var(--muted);margin-top:4px}
    .pill{display:inline-flex;align-items:center;gap:6px;padding:6px 10px;border-radius:999px;background:#0f1218;border:1px solid rgba(255,255,255,.12);font-size:12px;color:#cbd5e1}
    .spacer{height:8px}
  </style>
  <script src="https://telegram.org/js/telegram-web-app.js"></script>
</head>
<body>
  <div class="wrap">
    <div class="card">
      <p class="title">最短フォーム</p>
      <p class="muted">「今すぐ」か、4桁を入力して送信してください。送信後、Bot に <code>web_app_data</code> として渡されます。</p>

      <div class="row">
        <button id="btnNow" class="btn primary">今すぐ</button>
        <span id="baseTimeView" class="pill">基準時刻: 未設定</span>
      </div>

      <div class="row">
        <div class="field">
          <input id="last4" class="input" inputmode="numeric" autocomplete="one-time-code"
                 maxlength="4" pattern="\d{4}" placeholder="下4桁" />
          <div class="help">電話番号の下4桁を半角数字で入力</div>
        </div>
        <button id="btnSend" class="btn ok">送信</button>
      </div>

      <div class="spacer"></div>
      <p class="muted" id="status">準備完了</p>
    </div>
  </div>

<script>
(function(){
  const tg = window.Telegram && window.Telegram.WebApp ? window.Telegram.WebApp : null;
  const $ = (id)=>document.getElementById(id);
  const state = { baseTimeIso: null };

  function setStatus(msg){ $('status').textContent = msg; }

  function setBaseNow(){
    const now = new Date();
    state.baseTimeIso = now.toISOString();
    $('baseTimeView').textContent = '基準時刻: 今すぐ (' + now.toLocaleString() + ')';
    setStatus('基準時刻を「今すぐ」に設定しました');
    if(tg && tg.HapticFeedback){ try{ tg.HapticFeedback.impactOccurred('light'); }catch(e){} }
  }

  function validateLast4(v){
    return /^\d{4}$/.test(v);
  }

  function send(){
    const last4 = $('last4').value.trim();
    if(!validateLast4(last4)){
      setStatus('下4桁は半角数字4桁で入力してください');
      alert('下4桁は半角数字4桁で入力してください');
      return;
    }
    if(!state.baseTimeIso){
      // デフォルトは「今すぐ」
      setBaseNow();
    }

    const payload = {
      action: 'shortest',
      baseTime: state.baseTimeIso,
      last4: last4,
      // 将来拡張フィールド（空文字で送る）
      groupKey: '',
      version: 'twa-v1'
    };

    if(tg){
      try {
        tg.ready();
        tg.expand();
        tg.sendData(JSON.stringify(payload));
        setStatus('送信しました。Telegramに戻ってください。');
        // 送信後に閉じる
        setTimeout(()=>tg.close(), 300);
      } catch (e) {
        console.error(e);
        setStatus('送信エラー: ' + e.message);
        alert('送信に失敗しました: ' + e.message);
      }
    }else{
      // テスト用（ブラウザ直アクセス時）
      console.log('DEV payload', payload);
      setStatus('（デバッグ）payload を console に出力しました。');
      alert('Telegram外テスト: ' + JSON.stringify(payload, null, 2));
    }
  }

  // イベント結線
  $('btnNow').addEventListener('click', setBaseNow);
  $('btnSend').addEventListener('click', send);

  // 初期化表示
  if(tg){
    tg.ready();
    tg.expand();
    setStatus('Telegram WebApp と接続しました');
  }else{
    setStatus('スタンドアロン（デバッグ）モードで起動しました');
  }
})();
</script>
</body>
</html>
