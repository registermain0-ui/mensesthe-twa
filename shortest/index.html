<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>TWA Debug</title>
  <style>
    :root { color-scheme: dark; }
    body{font-family:system-ui, -apple-system,'Segoe UI',Roboto,'Meiryo',sans-serif;background:#0f172a;color:#e5e7eb;padding:18px}
    .card{max-width:700px;margin:0 auto;background:#111827;border:1px solid #1f2937;border-radius:16px;padding:16px}
    pre{white-space:pre-wrap;background:#0b1220;border:1px solid #1f2937;padding:10px;border-radius:8px}
    button{padding:10px 14px;border-radius:8px;border:1px solid #374151;background:#1f2937;color:#e5e7eb;cursor:pointer}
    .row{display:flex;gap:8px;margin:8px 0}
    input{width:200px;padding:8px;border-radius:8px;border:1px solid #374151;background:#0b1220;color:#e5e7eb}
  </style>
</head>
<body>
  <div class="card">
    <h1>TWA Debug</h1>
    <div class="row">
      <input id="payload" placeholder='{"hello":"world"}' value='{"hello":"world"}'/>
      <button id="btnSend">sendData</button>
      <button id="btnAlert">showAlert</button>
    </div>
    <h3>Environment</h3>
    <pre id="env"></pre>
    <h3>Events</h3>
    <pre id="log"></pre>
  </div>
<script>
(function(){
  const $ = id => document.getElementById(id);
  const log = (m)=>{ const el=$("log"); el.textContent += m+"\\n"; };
  const env = (o)=>{ $("env").textContent = JSON.stringify(o,null,2); };

  const tg = window.Telegram && window.Telegram.WebApp ? window.Telegram.WebApp : null;
  if (tg){
    try{ tg.ready(); }catch(e){}
    try{ tg.expand(); }catch(e){}
  }

  env({
    href: location.href,
    origin: location.origin,
    tg_exists: !!tg,
    version: tg && tg.version,
    platform: tg && tg.platform,
    colorScheme: tg && tg.colorScheme,
    isExpanded: tg && tg.isExpanded,
    initData: tg && tg.initData,
    initDataUnsafe: tg && tg.initDataUnsafe
  });

  if (tg){
    tg.onEvent('themeChanged', ()=>log('themeChanged'));
    tg.onEvent('mainButtonClicked', ()=>log('mainButtonClicked'));
    tg.onEvent('viewportChanged', (e)=>log('viewportChanged:' + JSON.stringify(e)));
  }

  $("btnSend").addEventListener("click", ()=>{
    try{
      const js = $("payload").value;
      const parsed = JSON.parse(js);
      if (!tg) throw new Error("Telegram.WebApp is null");
      tg.sendData(JSON.stringify(parsed));
      log("sendData: OK");
      tg.showPopup({title:"送信", message:"sendData OK"});
    }catch(e){
      console.error(e);
      log("sendData ERROR: " + (e && e.message));
      if (tg && tg.showAlert) tg.showAlert("sendData ERROR: " + (e && e.message));
    }
  });

  $("btnAlert").addEventListener("click", ()=>{
    if (tg && tg.showAlert) tg.showAlert("alert OK");
    log("showAlert clicked");
  });
})();
</script>
</body>
</html>
